<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4: Motion Detection (Nano 33 IoT) + Web UI (RPi) | IoT Workshop</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@300;400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#8b5cf6; --primary2:#7c3aed;
      --secondary:#2563eb; --accent:#f59e0b;
      --bg:#0f172a; --card:#111c33;
      --muted:#94a3b8; --text:#f1f5f9;
      --border:rgba(255,255,255,.10);
      --code:#0b1224;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:'IBM Plex Sans Thai',sans-serif; background:radial-gradient(900px 420px at 15% 10%, rgba(139,92,246,.28), transparent 60%), radial-gradient(800px 380px at 85% 0%, rgba(37,99,235,.22), transparent 55%), var(--bg); color:var(--text); line-height:1.85}
    a{color:inherit}
    .container{width:min(1100px,92%); margin:0 auto}

    /* Topbar */
    .topbar{position:sticky; top:0; z-index:999; background:rgba(15,23,42,.85); backdrop-filter: blur(10px); border-bottom:1px solid var(--border)}
    .topbar-inner{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0}
    .brand{display:inline-flex; gap:10px; align-items:center; text-decoration:none; font-weight:800; letter-spacing:-.01em}
    .navlinks{display:flex; flex-wrap:wrap; gap:8px}
    .navlinks a{font-weight:700; text-decoration:none; color:rgba(241,245,249,.85); padding:8px 12px; border-radius:999px; border:1px solid transparent; transition:.2s}
    .navlinks a:hover{background:rgba(37,99,235,.18); border-color:rgba(37,99,235,.25)}
    .navlinks a.active{background:rgba(139,92,246,.22); border-color:rgba(139,92,246,.35)}
    @media (max-width:900px){.navlinks{display:none}}

    /* Hero */
    header{padding:44px 0 22px; border-bottom:1px solid var(--border)}
    .badge{display:inline-flex; gap:8px; align-items:center; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.18); padding:6px 12px; border-radius:999px; font-weight:700; color:rgba(255,255,255,.92)}
    h1{margin:14px 0 8px; font-size:clamp(26px, 3.1vw, 42px); line-height:1.25}
    .subtitle{margin:0; color:rgba(241,245,249,.85); font-size:clamp(14px, 1.5vw, 18px)}

    /* Sections */
    main{padding:26px 0 60px}
    section{margin-top:26px}
    h2{margin:0 0 12px; font-size:clamp(20px,2.2vw,30px); color:#c4b5fd}
    h3{margin:18px 0 10px; font-size:20px; color:#93c5fd}
    p{margin:10px 0; color:rgba(241,245,249,.82)}

    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:14px}
    .card{grid-column:span 12; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 10px 26px rgba(0,0,0,.25)}
    .card.soft{background:rgba(17,28,51,.72)}
    .cols-6{grid-column:span 6}
    @media(max-width:900px){.cols-6{grid-column:span 12}}

    .pill{display:inline-flex; align-items:center; gap:8px; padding:5px 10px; border-radius:999px; border:1px solid var(--border); color:rgba(241,245,249,.85); font-weight:700; font-size:12px}
    .pill.ok{border-color:rgba(16,185,129,.35); background:rgba(16,185,129,.08)}
    .pill.warn{border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.08)}

    .callout{border-left:4px solid var(--secondary); padding:12px 14px; border-radius:12px; background:rgba(37,99,235,.10); border:1px solid rgba(37,99,235,.18)}
    .callout.ok{border-left-color:var(--ok); background:rgba(16,185,129,.10); border-color:rgba(16,185,129,.18)}
    .callout.warn{border-left-color:var(--warn); background:rgba(245,158,11,.10); border-color:rgba(245,158,11,.18)}

    /* Steps */
    .steps{display:grid; gap:12px}
    .step{display:grid; grid-template-columns:42px 1fr; gap:12px; align-items:flex-start}
    .num{width:42px; height:42px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-weight:900; background:rgba(139,92,246,.22); border:1px solid rgba(139,92,246,.35)}

    /* Code */
    details.code-details{border:1px solid var(--border); border-radius:14px; overflow:hidden; background:rgba(11,18,36,.55)}
    details.code-details>summary{cursor:pointer; list-style:none; padding:12px 14px; display:flex; align-items:center; justify-content:space-between; gap:10px; font-weight:800; color:rgba(241,245,249,.92)}
    details.code-details>summary::-webkit-details-marker{display:none}
    .summary-right{display:flex; gap:8px; align-items:center; color:rgba(241,245,249,.75); font-weight:700; font-size:12px}
    .kbd{font-family:'JetBrains Mono',monospace; font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.05)}

    .code-wrap{position:relative; border-top:1px solid var(--border)}
    .copy{position:absolute; top:10px; right:10px; font-size:12px; font-weight:800; color:rgba(241,245,249,.86); background:rgba(255,255,255,.08); border:1px solid var(--border); border-radius:10px; padding:6px 10px; cursor:pointer}
    .copy:hover{background:rgba(255,255,255,.12)}
    pre{margin:0; padding:14px; overflow:auto; background:transparent; font-family:'JetBrains Mono',monospace; font-size:13px; line-height:1.6}
    code{color:rgba(241,245,249,.92)}
    .inline{font-family:'JetBrains Mono',monospace; font-size:.95em; background:rgba(255,255,255,.08); border:1px solid var(--border); padding:2px 6px; border-radius:8px}

    /* Table */
    table{width:100%; border-collapse:collapse; overflow:hidden; border-radius:14px; border:1px solid var(--border)}
    th,td{padding:10px 12px; border-bottom:1px solid var(--border); text-align:left; vertical-align:top; font-size:14px}
    th{background:rgba(139,92,246,.14); color:rgba(241,245,249,.92)}
    tr:last-child td{border-bottom:none}

    footer{margin-top:46px; padding:22px 0 34px; border-top:1px solid var(--border); color:rgba(241,245,249,.65)}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="container topbar-inner">
      <a class="brand" href="index.html">üè† IoT Workshop</a>
      <nav class="navlinks" aria-label="Course navigation">
        <a href="lesson-01-introduction.html">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1</a>
        <a href="lesson-02-fastapi-server.html">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2</a>
        <a href="lesson-03-nano33iot-client.html">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3</a>
        <a href="lesson-04-motion-detection.html" class="active">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4</a>
      </nav>
    </div>
  </div>

  <header>
    <div class="container">
      <span class="badge">‡∏ö‡∏ó‡∏ó‡∏µ‡πà 4 ‡∏à‡∏≤‡∏Å 4 ‚Ä¢ Motion Detection + Web UI</span>
      <h1>üéØ ‡∏ï‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°: Nano 33 IoT ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß (PIR) ‚Üí ‡∏™‡πà‡∏á HTTP ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡πÄ‡∏ß‡πá‡∏ö (RPi)</h1>
      <p class="subtitle">‡πÄ‡∏£‡∏≤‡∏à‡∏∞ ‚Äú‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‚Äù ‡πÄ‡∏Ç‡πâ‡∏≤ FastAPI Server ‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2 ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ <span class="inline">/api/data</span> ‡πÅ‡∏•‡∏∞ <span class="inline">/api/latest</span> ‡∏û‡∏±‡∏á ‡πÅ‡∏•‡∏∞ **‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•** (‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</p>
    </div>
  </header>

  <main class="container">

    <section id="overview">
      <h2>1) ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á</h2>
      <div class="grid">
        <div class="card cols-6">
          <h3>‡∏ù‡∏±‡πà‡∏á RPi (Server ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2)</h3>
          <ul>
            <li>‡πÄ‡∏û‡∏¥‡πà‡∏° endpoint ‡πÉ‡∏´‡∏°‡πà: <span class="inline">POST /api/motion</span></li>
            <li>‡πÄ‡∏û‡∏¥‡πà‡∏° endpoint ‡πÉ‡∏´‡∏°‡πà: <span class="inline">GET /api/motion/latest</span></li>
            <li>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà: <span class="inline">GET /motion</span> (‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ motion ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</li>
            <li><span class="pill ok">‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ DB</span> ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ (‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó server ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢)</li>
          </ul>
        </div>
        <div class="card cols-6">
          <h3>‡∏ù‡∏±‡πà‡∏á Nano 33 IoT (PIR Motion)</h3>
          <ul>
            <li>‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì PIR ‡∏ó‡∏µ‡πà‡∏Ç‡∏≤ <span class="inline">D2</span> (HIGH/LOW)</li>
            <li>‡∏™‡πà‡∏á JSON ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <span class="inline">/api/motion</span></li>
            <li>‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô ‚Äú‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‚Äù + ‡∏°‡∏µ cooldown ‡∏Å‡∏±‡∏ô‡∏™‡πÅ‡∏õ‡∏°</li>
          </ul>
        </div>
      </div>

      <div class="callout ok" style="margin-top:14px;">
        <strong>‡∏ó‡∏≥‡πÑ‡∏°‡∏ö‡∏ó‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡πà‡∏≤ ‚Äú‡∏ï‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‚Äù ?</strong>
        <p style="margin:8px 0 0;">‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° route ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå <span class="inline">app.py</span> ‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‚Äî ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° (‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3 ‡∏¢‡∏±‡∏á‡∏™‡πà‡∏á virtual sensor ‡πÄ‡∏Ç‡πâ‡∏≤ <span class="inline">/api/data</span> ‡πÑ‡∏î‡πâ)</p>
      </div>
    </section>


    <section id="step-server">
      <h2>2) Step-by-step: ‡πÄ‡∏û‡∏¥‡πà‡∏° Motion API ‡πÉ‡∏ô FastAPI (‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2)</h2>

      <div class="card soft">
        <div class="steps">
          <div class="step">
            <div class="num">1</div>
            <div>
              <p><strong>‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°</strong> ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏ô‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2: <span class="inline">~/iot-server/app.py</span></p>
              <p>‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° ‚Äú‡πÇ‡∏Ñ‡πâ‡∏î motion‚Äù <strong>‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°</p>
            </div>
          </div>

          <div class="step">
            <div class="num">2</div>
            <div>
              <p><strong>‡πÄ‡∏û‡∏¥‡πà‡∏° import</strong> (‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)</p>
              <details class="code-details">
                <summary>
                  ‡πÄ‡∏û‡∏¥‡πà‡∏° import ‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡πÑ‡∏ü‡∏•‡πå <span class="summary-right"><span class="kbd">Python</span></span>
                </summary>
                <div class="code-wrap">
                  <button class="copy" data-copy="code-import">Copy</button>
                  <pre id="code-import"><code>from fastapi import Request
from fastapi.responses import FileResponse
from collections import deque
from pathlib import Path
from typing import Optional
</code></pre>
                </div>
              </details>
              <div class="callout warn" style="margin-top:10px;">
                <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</strong>
                <p style="margin:6px 0 0;">‡πÉ‡∏ô‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2 ‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ <span class="inline">FastAPI</span> ‡πÅ‡∏•‡∏∞ <span class="inline">BaseModel</span> ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Äî ‡πÄ‡∏£‡∏≤‡πÅ‡∏Ñ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UI + ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥</p>
              </div>
            </div>
          </div>

          <div class="step">
            <div class="num">3</div>
            <div>
              <p><strong>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î Motion Add-on</strong> ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå <span class="inline">app.py</span></p>
              <details class="code-details" open>
                <summary>
                  Motion Add-on (‡πÅ‡∏õ‡∏∞‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå app.py) <span class="summary-right"><span class="kbd">Python</span> <span class="pill ok">no DB</span></span>
                </summary>
                <div class="code-wrap">
                  <button class="copy" data-copy="code-motion-addon">Copy</button>
                  <pre id="code-motion-addon"><code># =============================
# Motion Add-on (Lesson 4)
# - POST /api/motion
# - GET  /api/motion/latest
# - GET  /motion  (Web UI)
# =============================

BASE_DIR = Path(__file__).resolve().parent

# ‡πÄ‡∏Å‡πá‡∏ö motion ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ database)
MOTION_EVENTS = deque(maxlen=50)  # ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£

class MotionPayload(BaseModel):
    device_id: str = "nano33iot-01"
    event: str = "motion_detected"
    motion: bool = True
    rssi: Optional[int] = None
    millis: Optional[int] = None
    source: str = "pir"
    ts: Optional[str] = None  # ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏°‡∏≤ ‡πÉ‡∏´‡πâ server ‡πÉ‡∏™‡πà‡πÄ‡∏≠‡∏á

@app.post("/api/motion")
def receive_motion(request: Request, payload: MotionPayload):
    # ‡πÄ‡∏ß‡∏•‡∏≤: ‡∏ñ‡πâ‡∏≤ client ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á ts ‡∏°‡∏≤‡πÉ‡∏´‡πâ server ‡πÉ‡∏™‡πà UTC ‡πÉ‡∏´‡πâ
    ts = payload.ts or datetime.utcnow().isoformat()

    # ‡πÄ‡∏Å‡πá‡∏ö IP ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á (‡∏ä‡πà‡∏ß‡∏¢ debug)
    ip = request.client.host if request.client else "unknown"

    item = {
        "ts": ts,
        "device_id": payload.device_id,
        "event": payload.event,
        "motion": payload.motion,
        "rssi": payload.rssi,
        "millis": payload.millis,
        "source": payload.source,
        "ip": ip,
    }

    # ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏´‡∏±‡∏ß‡πÅ‡∏ñ‡∏ß (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô)
    MOTION_EVENTS.appendleft(item)

    return {"ok": True, "item": item}

@app.get("/api/motion/latest")
def motion_latest(limit: int = 20):
    limit = max(1, min(int(limit), len(MOTION_EVENTS))) if MOTION_EVENTS else 0
    return {"items": list(MOTION_EVENTS)[:limit]}

@app.get("/motion")
def motion_page():
    # ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á motion_ui.html ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö app.py)
    return FileResponse(BASE_DIR / "motion_ui.html")
</code></pre>
                </div>
              </details>

              <div class="callout" style="margin-top:12px;">
                <strong>‡∏ó‡∏≥‡πÑ‡∏°‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ deque?</strong>
                <p style="margin:6px 0 0;">‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö ‚Äú‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‚Äù ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡πÜ (‡πÄ‡∏ä‡πà‡∏ô 50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) ‡πÑ‡∏°‡πà‡∏Å‡∏¥‡∏ô RAM ‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ DB</p>
              </div>

            </div>
          </div>

          <div class="step">
            <div class="num">4</div>
            <div>
              <p><strong>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</strong> ‡∏ä‡∏∑‡πà‡∏≠ <span class="inline">motion_ui.html</span> ‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö <span class="inline">app.py</span></p>
              <details class="code-details">
                <summary>
                  motion_ui.html (‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•) <span class="summary-right"><span class="kbd">HTML</span> <span class="pill">auto-refresh</span></span>
                </summary>
                <div class="code-wrap">
                  <button class="copy" data-copy="code-motion-ui">Copy</button>
                  <pre id="code-motion-ui"><code>&lt;!doctype html&gt;
&lt;html lang=&quot;th&quot;&gt;
&lt;head&gt;
  &lt;meta charset=&quot;utf-8&quot;&gt;
  &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,initial-scale=1&quot;&gt;
  &lt;title&gt;Motion Monitor&lt;/title&gt;
  &lt;style&gt;
    :root{--bg:#0f172a;--card:#111c33;--line:rgba(255,255,255,.12);--text:#f1f5f9;--muted:#94a3b8;--ok:#10b981;--warn:#f59e0b}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,&quot;Noto Sans Thai&quot;,sans-serif;background:radial-gradient(900px 420px at 15% 10%, rgba(139,92,246,.28), transparent 60%), var(--bg);color:var(--text)}
    .container{width:min(980px,92%);margin:0 auto;padding:18px 0}
    .header{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;margin-bottom:14px}
    h1{margin:0;font-size:22px}
    .muted{color:var(--muted);font-size:13px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 10px 26px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:10px}
    .pill{font-size:12px;border:1px solid var(--line);padding:4px 10px;border-radius:999px;color:var(--muted)}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:13px}
    th{background:rgba(139,92,246,.14);color:rgba(241,245,249,.92)}
    tr:last-child td{border-bottom:none}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,&quot;Liberation Mono&quot;,monospace}
    .ok{color:var(--ok);font-weight:700}
    .warn{color:var(--warn);font-weight:700}
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div class=&quot;container&quot;&gt;
    &lt;div class=&quot;header&quot;&gt;
      &lt;div&gt;
        &lt;h1&gt;üö® Motion Monitor&lt;/h1&gt;
        &lt;div class=&quot;muted&quot;&gt;‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å &lt;span class=&quot;mono&quot;&gt;/api/motion/latest&lt;/span&gt; ‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ DB)&lt;/div&gt;
      &lt;/div&gt;
      &lt;div class=&quot;muted&quot; id=&quot;status&quot;&gt;loading...&lt;/div&gt;
    &lt;/div&gt;

    &lt;div class=&quot;card&quot;&gt;
      &lt;div class=&quot;row&quot;&gt;
        &lt;div&gt;&lt;strong&gt;Events ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î&lt;/strong&gt;&lt;/div&gt;
        &lt;div class=&quot;pill&quot;&gt;POST /api/motion&lt;/div&gt;
      &lt;/div&gt;
      &lt;table&gt;
        &lt;thead&gt;
          &lt;tr&gt;
            &lt;th&gt;‡πÄ‡∏ß‡∏•‡∏≤ (UTC)&lt;/th&gt;
            &lt;th&gt;Device&lt;/th&gt;
            &lt;th&gt;Event&lt;/th&gt;
            &lt;th&gt;Motion&lt;/th&gt;
            &lt;th&gt;RSSI&lt;/th&gt;
            &lt;th&gt;Millis&lt;/th&gt;
            &lt;th&gt;IP&lt;/th&gt;
          &lt;/tr&gt;
        &lt;/thead&gt;
        &lt;tbody id=&quot;rows&quot;&gt;&lt;/tbody&gt;
      &lt;/table&gt;
    &lt;/div&gt;
  &lt;/div&gt;

  &lt;script&gt;
    async function refresh(){
      const status = document.getElementById('status');
      const rows = document.getElementById('rows');
      try{
        const r = await fetch('/api/motion/latest?limit=20', {cache:'no-store'});
        const data = await r.json();
        const items = data.items || [];

        status.textContent = `ok ‚Ä¢ items=${items.length} ‚Ä¢ ${new Date().toLocaleTimeString()}`;

        rows.innerHTML = items.map(it => {
          const motion = it.motion ? '<span class="ok">true</span>' : '<span class="warn">false</span>';
          return `
            <tr>
              <td class="mono">${it.ts ?? '-'}</td>
              <td class="mono">${it.device_id ?? '-'}</td>
              <td class="mono">${it.event ?? '-'}</td>
              <td class="mono">${motion}</td>
              <td class="mono">${it.rssi ?? '-'}</td>
              <td class="mono">${it.millis ?? '-'}</td>
              <td class="mono">${it.ip ?? '-'}</td>
            </tr>
          `;
        }).join('');
      }catch(e){
        status.textContent = 'error: ' + e;
      }
    }

    refresh();
    setInterval(refresh, 1000);
  &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
                </div>
              </details>

              <div class="callout warn" style="margin-top:12px;">
                <strong>‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å ‚Äú‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‚Äù</strong>
                <p style="margin:6px 0 0;">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ return HTMLResponse ‡πÉ‡∏ô <span class="inline">@app.get('/motion')</span> ‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤</p>
              </div>
            </div>
          </div>

          <div class="step">
            <div class="num">5</div>
            <div>
              <p><strong>‡∏£‡∏±‡∏ô server</strong> ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö</p>
              <details class="code-details">
                <summary>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏£‡∏±‡∏ô Uvicorn <span class="summary-right"><span class="kbd">Bash</span></span></summary>
                <div class="code-wrap">
                  <button class="copy" data-copy="code-run">Copy</button>
                  <pre id="code-run"><code>cd ~/iot-server
source .venv/bin/activate
uvicorn app:app --host 0.0.0.0 --port 8000
</code></pre>
                </div>
              </details>
              <div class="callout ok" style="margin-top:10px;">
                <strong>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</strong>
                <ul style="margin:8px 0 0 18px; color:rgba(241,245,249,.82)">
                  <li><span class="inline">http://&lt;RPi-IP&gt;:8000/docs</span> (‡∏ó‡∏î‡∏™‡∏≠‡∏ö API)</li>
                  <li><span class="inline">http://&lt;RPi-IP&gt;:8000/motion</span> (‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•)</li>
                  <li><span class="inline">http://&lt;RPi-IP&gt;:8000/api/motion/latest</span> (JSON)</li>
                </ul>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>


    <section id="step-test">
      <h2>3) ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡∏ö‡∏≠‡∏£‡πå‡∏î (‡∏¢‡∏¥‡∏á curl ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)</h2>
      <div class="card">
        <p>‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠ PIR ‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏¢‡∏¥‡∏á mock event ‡∏î‡πâ‡∏ß‡∏¢ <span class="inline">curl</span> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ server ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏î‡πâ</p>
        <details class="code-details" open>
          <summary>curl: POST /api/motion <span class="summary-right"><span class="kbd">Bash</span></span></summary>
          <div class="code-wrap">
            <button class="copy" data-copy="code-curl">Copy</button>
            <pre id="code-curl"><code>curl -X POST "http://&lt;RPi-IP&gt;:8000/api/motion" \
  -H "Content-Type: application/json" \
  -d '{
    "device_id": "nano33iot-01",
    "event": "motion_detected",
    "motion": true,
    "rssi": -55,
    "millis": 123456,
    "source": "pir"
  }'
</code></pre>
          </div>
        </details>
        <p style="margin-top:10px;">‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ <span class="inline">/motion</span> ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á (auto-refresh)</p>
      </div>
    </section>


    <section id="step-nano">
      <h2>4) Step-by-step: Nano 33 IoT + PIR ‚Üí ‡∏™‡πà‡∏á Motion Event</h2>

      <div class="grid">
        <div class="card cols-6">
          <h3>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå & ‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏≤‡∏¢</h3>
          <table>
            <thead><tr><th>‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th>‡∏ï‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö Nano 33 IoT</th></tr></thead>
            <tbody>
              <tr><td>PIR VCC</td><td>3.3V (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥) ‡∏´‡∏£‡∏∑‡∏≠ 5V (‡∏ñ‡πâ‡∏≤‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 3.3V OUT)</td></tr>
              <tr><td>PIR GND</td><td>GND</td></tr>
              <tr><td>PIR OUT</td><td>D2 (‡∏û‡∏¥‡∏ô‡πÄ‡∏•‡∏Ç 2)</td></tr>
            </tbody>
          </table>
          <div class="callout warn" style="margin-top:10px;">
            <strong>‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</strong>
            <p style="margin:6px 0 0;">Nano 33 IoT ‡πÄ‡∏õ‡πá‡∏ô <strong>3.3V logic</strong> ‚Äî ‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏≠‡∏≠‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì 5V ‡πÄ‡∏Ç‡πâ‡∏≤ GPIO ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á (‡∏ñ‡πâ‡∏≤ PIR OUT ‡πÄ‡∏õ‡πá‡∏ô 5V ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏ö‡πà‡∏á‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô/level shifter)</p>
          </div>
        </div>

        <div class="card cols-6">
          <h3>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÅ‡∏ï‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)</h3>
          <ul>
            <li><strong>PIR</strong> ‡πÉ‡∏´‡πâ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏ö‡∏ö digital: HIGH = ‡πÄ‡∏à‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß, LOW = ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠</li>
            <li>‡∏´‡∏•‡∏≤‡∏¢‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏ï‡πâ‡∏≠‡∏á <strong>warm-up 20‚Äì60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</strong> ‡∏´‡∏•‡∏±‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏ü</li>
            <li>‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</strong> ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á cooldown ‡∏Å‡∏±‡∏ô spam</li>
          </ul>
        </div>
      </div>

      <div class="card soft" style="margin-top:14px;">
        <div class="steps">

          <div class="step">
            <div class="num">1</div>
            <div>
              <p><strong>‡∏ó‡∏î‡∏™‡∏≠‡∏ö PIR ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡πà‡∏≠‡∏ô</strong> (‡∏≠‡πà‡∏≤‡∏ô D2 ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå HIGH/LOW)</p>
              <details class="code-details">
                <summary>PIR test <span class="summary-right"><span class="kbd">Arduino</span></span></summary>
                <div class="code-wrap">
                  <button class="copy" data-copy="code-pir-test">Copy</button>
                  <pre id="code-pir-test"><code>#define PIR_PIN 2

void setup(){
  Serial.begin(115200);
  pinMode(PIR_PIN, INPUT);
}

void loop(){
  int v = digitalRead(PIR_PIN);
  Serial.println(v == HIGH ? "MOTION" : "NO");
  delay(200);
}
</code></pre>
                </div>
              </details>
            </div>
          </div>

          <div class="step">
            <div class="num">2</div>
            <div>
              <p><strong>‡∏ï‡πà‡∏≠ Wi‚ÄëFi + ‡∏¢‡∏¥‡∏á HTTP POST</strong> (‡∏ô‡∏≥‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3 ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠)</p>
              <p style="margin-top:6px;">‡πÉ‡∏ô Nano 33 IoT ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ <span class="inline">WiFiNINA</span> + <span class="inline">ArduinoHttpClient</span> (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3)„ÄêÓàÄfileciteÓàÇturn1file1ÓàÅ„Äë</p>
            </div>
          </div>

          <div class="step">
            <div class="num">3</div>
            <div>
              <p><strong>‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏ï‡πá‡∏° (PIR + ‡∏™‡πà‡∏á /api/motion)</strong> ‚Äî ‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡∏£‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3 ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô PIR + state-change</p>
              <details class="code-details" open>
                <summary>nano33iot_pir_motion_http.ino <span class="summary-right"><span class="kbd">Arduino</span> <span class="pill ok">no DB</span></span></summary>
                <div class="code-wrap">
                  <button class="copy" data-copy="code-nano-full">Copy</button>
                  <pre id="code-nano-full"><code>#include &lt;WiFiNINA.h&gt;
#include &lt;ArduinoHttpClient.h&gt;

// ===== CONFIG (‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á/‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢) =====
const char* WIFI_SSID = "UBU-IoT";
const char* WIFI_PASS = "&lt;UBU_IoT_PASSWORD&gt;";

const char* SERVER_HOST = "192.168.1.50"; // IP ‡∏Ç‡∏≠‡∏á RPi (‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ localhost)
const int   SERVER_PORT = 8000;
const char* MOTION_PATH = "/api/motion";

String deviceId = "nano33iot-01";
// ============================================

// PIR (D2 => 2)
#define PIR_PIN 2

int status = WL_IDLE_STATUS;
WiFiClient wifi;
HttpClient http(wifi, SERVER_HOST, SERVER_PORT);

int motionState = LOW;
int prevMotionState = LOW;

// ‡∏Å‡∏±‡∏ô‡∏™‡πÅ‡∏õ‡∏°: ‡∏™‡πà‡∏á‡∏´‡πà‡∏≤‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
unsigned long lastSendMs = 0;
const unsigned long COOLDOWN_MS = 2000;

void connectWiFi(){
  Serial.print("Connecting WiFi");
  while (status != WL_CONNECTED) {
    status = WiFi.begin(WIFI_SSID, WIFI_PASS);
    delay(1000);
    Serial.print(".");
  }
  Serial.println();
  Serial.print("WiFi connected, IP = ");
  Serial.println(WiFi.localIP());
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á JSON payload ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö server
String buildMotionPayload(const char* eventType, bool motion){
  String body = "{";
  body += "\"device_id\":\"" + deviceId + "\",";
  body += "\"event\":\"" + String(eventType) + "\",";
  body += "\"motion\":" + String(motion ? "true" : "false") + ",";
  body += "\"rssi\":" + String(WiFi.RSSI()) + ",";
  body += "\"millis\":" + String(millis()) + ",";
  body += "\"source\":\"pir\"";
  body += "}";
  return body;
}

bool postJson(const String& path, const String& payload){
  http.beginRequest();
  http.post(path);
  http.sendHeader("Content-Type", "application/json");
  http.sendHeader("Content-Length", payload.length());
  http.beginBody();
  http.print(payload);
  http.endRequest();

  int code = http.responseStatusCode();
  String resp = http.responseBody();

  Serial.print("Status Code: ");
  Serial.println(code);
  Serial.print("Response: ");
  Serial.println(resp);

  return (code >= 200 && code < 300);
}

void setup(){
  Serial.begin(115200);
  delay(300);

  pinMode(PIR_PIN, INPUT);

  connectWiFi();
  Serial.println("Nano 33 IoT PIR -> HTTP ready");
}

void loop(){
  // Wi‚ÄëFi ‡∏´‡∏•‡∏∏‡∏î -> ‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà
  if (WiFi.status() != WL_CONNECTED){
    Serial.println("WiFi lost, reconnect...");
    status = WL_IDLE_STATUS;
    connectWiFi();
  }

  prevMotionState = motionState;
  motionState = digitalRead(PIR_PIN);

  // ‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ + cooldown
  if (prevMotionState != motionState){
    unsigned long now = millis();
    if (now - lastSendMs < COOLDOWN_MS) return;
    lastSendMs = now;

    if (motionState == HIGH){
      String payload = buildMotionPayload("motion_detected", true);
      Serial.println(payload);
      postJson(MOTION_PATH, payload);
    } else {
      String payload = buildMotionPayload("motion_stopped", false);
      Serial.println(payload);
      postJson(MOTION_PATH, payload);
    }
  }

  delay(30);
}
</code></pre>
                </div>
              </details>

              <div class="callout" style="margin-top:10px;">
                <strong>‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡πâ‡∏î (‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏£‡πá‡∏ß)</strong>
                <ul style="margin:8px 0 0 18px; color:rgba(241,245,249,.82)">
                  <li><span class="inline">PIR_PIN</span>: ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ HIGH/LOW</li>
                  <li><span class="inline">prevMotionState != motionState</span>: ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</li>
                  <li><span class="inline">COOLDOWN_MS</span>: ‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏ô/‡∏™‡πÅ‡∏õ‡∏° event</li>
                  <li><span class="inline">postJson()</span>: ‡∏ï‡∏±‡πâ‡∏á header JSON + ‡∏™‡πà‡∏á body</li>
                </ul>
              </div>

            </div>
          </div>

        </div>
      </div>

      <div class="callout ok" style="margin-top:14px;">
        <strong>‡∏ó‡∏î‡∏™‡∏≠‡∏ö End-to-End</strong>
        <p style="margin:8px 0 0;">‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ <span class="inline">http://&lt;RPi-IP&gt;:8000/motion</span> ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô PIR ‚Üí ‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</p>
      </div>
    </section>


    <section id="troubleshoot">
      <h2>5) Troubleshooting (‡πÄ‡∏à‡∏≠‡∏ö‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</h2>
      <div class="grid">
        <div class="card cols-6">
          <h3>‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á Server</h3>
          <ul>
            <li>‡πÄ‡∏ä‡πá‡∏Ñ <span class="inline">SERVER_HOST</span> ‡πÄ‡∏õ‡πá‡∏ô IP ‡∏Ç‡∏≠‡∏á RPi ‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà <span class="inline">localhost</span>)</li>
            <li>RPi + Nano ‡∏≠‡∏¢‡∏π‡πà Wi‚ÄëFi ‡∏ß‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</li>
            <li>Server ‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà: <span class="inline">uvicorn app:app --port 8000</span></li>
          </ul>
        </div>
        <div class="card cols-6">
          <h3>PIR ‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô</h3>
          <ul>
            <li>‡∏£‡∏≠ warm-up 20‚Äì60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</li>
            <li>‡πÄ‡∏ä‡πá‡∏Ñ‡πÑ‡∏ü‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á + GND ‡∏£‡πà‡∏ß‡∏°</li>
            <li>‡∏•‡∏≠‡∏á‡∏™‡∏•‡∏±‡∏ö <span class="inline">pinMode(PIR_PIN, INPUT_PULLDOWN)</span> ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ô‡∏¥‡πà‡∏á (‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡πÇ‡∏°‡∏î‡∏π‡∏•)</li>
          </ul>
        </div>
      </div>
    </section>


    <section id="summary">
      <h2>6) ‡∏™‡∏£‡∏∏‡∏õ</h2>
      <div class="card">
        <ul>
          <li>‡πÄ‡∏£‡∏≤ ‚Äú‡∏ï‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‚Äù FastAPI Server ‡πÄ‡∏î‡∏¥‡∏° (‡∏ö‡∏ó‡∏ó‡∏µ‡πà 2) ‡πÇ‡∏î‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏° Motion API + Web UI</li>
          <li>‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ Nano 33 IoT ‡∏≠‡πà‡∏≤‡∏ô PIR ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á JSON ‡πÄ‡∏Ç‡πâ‡∏≤ server ‡∏ú‡πà‡∏≤‡∏ô HTTP</li>
          <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (in-memory) ‚Äî ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
        </ul>
      </div>

      <div class="callout ok">
        <strong>‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤)</strong>
        <ul style="margin:8px 0 0 18px; color:rgba(241,245,249,.82)">
          <li>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á buzzer/LED ‡∏ó‡∏µ‡πà Nano ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≠ motion</li>
          <li>‡πÄ‡∏û‡∏¥‡πà‡∏° ‚Äú‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û snapshot‚Äù (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ webcam ‡∏ö‡∏ô RPi) ‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏ä‡∏ß‡πå‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤ /motion</li>
          <li>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° LINE notify / email notify ‡πÄ‡∏°‡∏∑‡πà‡∏≠ motion_detected</li>
        </ul>
      </div>
    </section>

    <footer>
      <div class="container">
        <div style="display:flex; flex-wrap:wrap; gap:12px; justify-content:space-between; align-items:center;">
          <span>¬© IoT Workshop ‚Ä¢ Lesson 4</span>
          <span style="display:flex; gap:10px;">
            <a href="index.html">Home</a>
            <a href="lesson-03-nano33iot-client.html">‚Üê ‡∏ö‡∏ó‡∏ó‡∏µ‡πà 3</a>
          </span>
        </div>
      </div>
    </footer>

  </main>

  <script>
    // Copy buttons for code blocks
    document.querySelectorAll('.copy').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-copy');
        const el = document.getElementById(id);
        if(!el) return;
        const text = el.innerText;
        try{
          await navigator.clipboard.writeText(text);
          const old = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(()=>btn.textContent=old, 900);
        }catch(e){
          // fallback
          const ta = document.createElement('textarea');
          ta.value = text; document.body.appendChild(ta);
          ta.select(); document.execCommand('copy');
          document.body.removeChild(ta);
          const old = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(()=>btn.textContent=old, 900);
        }
      });
    });
  </script>
</body>
</html>
